#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "${GREEN}Running pre-commit hooks...${NC}"

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Filter TypeScript files
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

# Check for TODO/FIXME in staged files (warning only)
echo "${YELLOW}Checking for TODO/FIXME comments...${NC}"
TODO_FOUND=false

for file in $STAGED_FILES; do
  if grep -E '(TODO|FIXME):' "$file" > /dev/null 2>&1; then
    echo "${YELLOW}⚠️  Found TODO/FIXME in $file${NC}"
    TODO_FOUND=true
  fi
done

if [ "$TODO_FOUND" = true ]; then
  echo "${YELLOW}Warning: Please review TODO/FIXME comments before committing${NC}"
fi

# Run prettier on staged files
if [ ! -z "$STAGED_FILES" ]; then
  echo "${GREEN}Running Prettier...${NC}"
  echo "$STAGED_FILES" | xargs npx prettier --write
  git add $STAGED_FILES
fi

# Run ESLint on TypeScript files
if [ ! -z "$TS_FILES" ]; then
  echo "${GREEN}Running ESLint on TypeScript files...${NC}"
  echo "$TS_FILES" | xargs npx eslint --fix
  git add $TS_FILES
fi

# Run TypeScript type checking
echo "${GREEN}Running TypeScript type checking...${NC}"
npx tsc --noEmit --skipLibCheck || {
  echo "${RED}TypeScript type checking failed!${NC}"
  exit 1
}

echo "${GREEN}All pre-commit checks passed!${NC}"
