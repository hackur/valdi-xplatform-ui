name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0 or 1.1.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi
          echo "Version validation passed: $VERSION"

      - name: Check if tag already exists
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists!"
            exit 1
          fi
          echo "Tag v$VERSION does not exist, proceeding with release"

  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          CI: true

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Update version in package.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          npm version $VERSION --no-git-tag-v
          echo "Updated version to: $VERSION"

      - name: Run type check
        run: npm run type-check
        continue-on-error: false

      - name: Run linter
        run: npm run lint
        continue-on-error: false

      - name: Run tests
        run: npm run test:ci
        continue-on-error: false

      - name: Generate changelog entry
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_DATE=$(date -u +"%Y-%m-%d")
          CHANGELOG_ENTRY="## [$VERSION] - $RELEASE_DATE\n\n### Added\n- \n\n### Changed\n- \n\n### Fixed\n- \n\n### Removed\n- \n"

          # Prepend to CHANGELOG.md if it exists, otherwise create it
          if [ -f "CHANGELOG.md" ]; then
            echo -e "$CHANGELOG_ENTRY\n$(cat CHANGELOG.md)" > CHANGELOG.md
          else
            echo -e "$CHANGELOG_ENTRY" > CHANGELOG.md
          fi

          echo "Generated changelog entry:"
          head -20 CHANGELOG.md

      - name: Commit version bump and changelog
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore: bump version to $VERSION" || echo "No changes to commit"

      - name: Create and push tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION" || echo "Tag already exists"
          git push origin "v$VERSION" || echo "Tag push failed"

      - name: Push version commit
        run: |
          git push origin HEAD:${{ github.ref }} || echo "Version commit push failed"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version }}
          release_name: Release v${{ github.event.inputs.version }}
          body: |
            # Release v${{ github.event.inputs.version }}

            Release automatically generated by GitHub Actions.

            For detailed changes, please see [CHANGELOG.md](./CHANGELOG.md)

            ## Installation

            ```bash
            npm install valdi-ai-ui@${{ github.event.inputs.version }}
            ```

            ## Key Updates

            Please update the changelog with specific features, fixes, and changes for this release.
          draft: true
          prerelease: false

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: prepare-release
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment on PR with release info
        if: github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ github.event.inputs.version }}';
            const releaseType = '${{ github.event.inputs.release_type }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ Release v${version} (${releaseType}) has been created!

              The release is in draft status. Please review the generated changelog and publish when ready.

              [View Release](https://github.com/${{ github.repository }}/releases/tag/v${version})`
            });

      - name: Release summary
        run: |
          echo "Release Summary"
          echo "==============="
          echo "Version: v${{ github.event.inputs.version }}"
          echo "Type: ${{ github.event.inputs.release_type }}"
          echo "Status: Complete"
          echo ""
          echo "Next Steps:"
          echo "1. Review the generated changelog"
          echo "2. Visit: https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.version }}"
          echo "3. Publish the release"
